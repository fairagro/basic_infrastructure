apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-additional-config
data:
  proxy.config.php: |
    <?php
    $CONFIG = array (
      'trusted_proxies' => array(
        0 => '127.0.0.1',
        1 => '{{ .Values.allowed_reverse_proxy_ips }}',
      ),
      'forwarded_for_headers' => array('HTTP_X_FORWARDED_FOR'),
    );
  redis-session.ini: |
    {{- $redis_host_part := include "nextcloud.redis.fullname" .Subcharts.nextcloud }}
    {{- $redis_port := .Values.nextcloud.redis.master.service.ports.redis | default 6379 }}
    {{- $redis_password := .Values.nextcloud.redis.auth.password }}
    session.save_handler = redis
    session.save_path = "tcp://{{ $redis_host_part }}-master:{{ $redis_port }}?auth={{ $redis_password }}"
    redis.session.locking_enabled = 1
    redis.session.lock_retries = -1
    redis.session.lock_wait_time = 10000
