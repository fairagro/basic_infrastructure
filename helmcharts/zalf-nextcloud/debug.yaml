---
# Source: zalf-nextcloud/charts/fairagro-onlyoffice/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: test-fairagro-onlyoffice
  labels:
    helm.sh/chart: fairagro-onlyoffice-0.1.0
    app.kubernetes.io/name: fairagro-onlyoffice
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "8.0.1"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: zalf-nextcloud/charts/nextcloud/charts/redis/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
automountServiceAccountToken: true
metadata:
  name: test-redis
  namespace: "fairagro-keycloak"
  labels:
    app.kubernetes.io/name: redis
    helm.sh/chart: redis-17.13.2
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
---
# Source: zalf-nextcloud/charts/collabora-online/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: test-collabora-online
  labels:
    helm.sh/chart: collabora-online-1.1.11
    app.kubernetes.io/name: collabora-online
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "23.05.8.4.1"
    app.kubernetes.io/managed-by: Helm
data:
  username: YWRtaW4=
  password: eW91cjNsYXJ2YWhhc3Jlc29sdmVkVEhFbG9jazQu
---
# Source: zalf-nextcloud/charts/nextcloud/charts/redis/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: test-redis
  namespace: "fairagro-keycloak"
  labels:
    app.kubernetes.io/name: redis
    helm.sh/chart: redis-17.13.2
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  redis-password: "d2lsbFRIRWZyYWdtYXRpc213YW5lMnRvd2FyZHN0aGUzcXVhbnR1bWxvZ2ljaWFuLg=="
---
# Source: zalf-nextcloud/charts/nextcloud/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: test-nextcloud
  labels:
    app.kubernetes.io/name: nextcloud
    helm.sh/chart: nextcloud-4.6.4
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  nextcloud-username: "YWRtaW4="
  nextcloud-password: "dGhlMzY0MjdoYWhvbHVzZGlhbHNNWXNsb3RoLg=="
  nextcloud-token: "N3hvZ0pmU0NCeg=="
  smtp-username: "bmV4dGNsb3VkQGZhaXJhZ3JvLm5ldA=="
  smtp-password: "THlubmV0dGV3aWxsdHJlazZBQk9WRXRoZTJidXlvdXQu"
  smtp-host: "c210cC5ob3N0aW5nZXIuY29t"
---
# Source: zalf-nextcloud/templates/cloudflare-api-token-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: cloudflare-api-token-secret
type: Opaque
stringData:
  api-token: "zJ-WtB5ExoEkdPj9_p6rwhoa0IR1o8nT0e20oKOh"
---
# Source: zalf-nextcloud/templates/geant-acme-account-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: geant-acme-account-secret
type: Opaque
stringData:
  secret: "S3GmKAscQp1LNO7zR5WjeH2815h28-oKZjbk9XYoBSTvzF-xSAU_KqeMEhvLZ_-iyhrx2bHmf9jaTNCLufD9aw"
---
# Source: zalf-nextcloud/charts/collabora-online/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-collabora-online
  annotations:
    confighash: config-e8e504528cedfc6fafb09089c7254be4
  labels:
    helm.sh/chart: collabora-online-1.1.11
    app.kubernetes.io/name: collabora-online
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "23.05.8.4.1"
    app.kubernetes.io/managed-by: Helm
data:
  extra_params: --o:ssl.enable=false --o:ssl.termination=true
  server_name: collabora.fairagro.net
  aliasgroup1: https://nextcloud.fairagro.net:443
---
# Source: zalf-nextcloud/charts/nextcloud/charts/redis/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-redis-configuration
  namespace: "fairagro-keycloak"
  labels:
    app.kubernetes.io/name: redis
    helm.sh/chart: redis-17.13.2
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
data:
  redis.conf: |-
    # User-supplied common configuration:
    # Enable AOF https://redis.io/topics/persistence#append-only-file
    appendonly yes
    # Disable RDB persistence, AOF persistence already enabled.
    save ""
    # End of common configuration
  master.conf: |-
    dir /data
    # User-supplied master configuration:
    rename-command FLUSHDB ""
    rename-command FLUSHALL ""
    # End of master configuration
  replica.conf: |-
    dir /data
    # User-supplied replica configuration:
    rename-command FLUSHDB ""
    rename-command FLUSHALL ""
    # End of replica configuration
---
# Source: zalf-nextcloud/charts/nextcloud/charts/redis/templates/health-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-redis-health
  namespace: "fairagro-keycloak"
  labels:
    app.kubernetes.io/name: redis
    helm.sh/chart: redis-17.13.2
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
data:
  ping_readiness_local.sh: |-
    #!/bin/bash

    [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD="$(< "${REDIS_PASSWORD_FILE}")"
    [[ -n "$REDIS_PASSWORD" ]] && export REDISCLI_AUTH="$REDIS_PASSWORD"
    response=$(
      timeout -s 15 $1 \
      redis-cli \
        -h localhost \
        -p $REDIS_PORT \
        ping
    )
    if [ "$?" -eq "124" ]; then
      echo "Timed out"
      exit 1
    fi
    if [ "$response" != "PONG" ]; then
      echo "$response"
      exit 1
    fi
  ping_liveness_local.sh: |-
    #!/bin/bash

    [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD="$(< "${REDIS_PASSWORD_FILE}")"
    [[ -n "$REDIS_PASSWORD" ]] && export REDISCLI_AUTH="$REDIS_PASSWORD"
    response=$(
      timeout -s 15 $1 \
      redis-cli \
        -h localhost \
        -p $REDIS_PORT \
        ping
    )
    if [ "$?" -eq "124" ]; then
      echo "Timed out"
      exit 1
    fi
    responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}')
    if [ "$response" != "PONG" ] && [ "$responseFirstWord" != "LOADING" ] && [ "$responseFirstWord" != "MASTERDOWN" ]; then
      echo "$response"
      exit 1
    fi
  ping_readiness_master.sh: |-
    #!/bin/bash

    [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD="$(< "${REDIS_MASTER_PASSWORD_FILE}")"
    [[ -n "$REDIS_MASTER_PASSWORD" ]] && export REDISCLI_AUTH="$REDIS_MASTER_PASSWORD"
    response=$(
      timeout -s 15 $1 \
      redis-cli \
        -h $REDIS_MASTER_HOST \
        -p $REDIS_MASTER_PORT_NUMBER \
        ping
    )
    if [ "$?" -eq "124" ]; then
      echo "Timed out"
      exit 1
    fi
    if [ "$response" != "PONG" ]; then
      echo "$response"
      exit 1
    fi
  ping_liveness_master.sh: |-
    #!/bin/bash

    [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD="$(< "${REDIS_MASTER_PASSWORD_FILE}")"
    [[ -n "$REDIS_MASTER_PASSWORD" ]] && export REDISCLI_AUTH="$REDIS_MASTER_PASSWORD"
    response=$(
      timeout -s 15 $1 \
      redis-cli \
        -h $REDIS_MASTER_HOST \
        -p $REDIS_MASTER_PORT_NUMBER \
        ping
    )
    if [ "$?" -eq "124" ]; then
      echo "Timed out"
      exit 1
    fi
    responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}')
    if [ "$response" != "PONG" ] && [ "$responseFirstWord" != "LOADING" ]; then
      echo "$response"
      exit 1
    fi
  ping_readiness_local_and_master.sh: |-
    script_dir="$(dirname "$0")"
    exit_status=0
    "$script_dir/ping_readiness_local.sh" $1 || exit_status=$?
    "$script_dir/ping_readiness_master.sh" $1 || exit_status=$?
    exit $exit_status
  ping_liveness_local_and_master.sh: |-
    script_dir="$(dirname "$0")"
    exit_status=0
    "$script_dir/ping_liveness_local.sh" $1 || exit_status=$?
    "$script_dir/ping_liveness_master.sh" $1 || exit_status=$?
    exit $exit_status
---
# Source: zalf-nextcloud/charts/nextcloud/charts/redis/templates/scripts-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-redis-scripts
  namespace: "fairagro-keycloak"
  labels:
    app.kubernetes.io/name: redis
    helm.sh/chart: redis-17.13.2
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
data:
  start-master.sh: |
    #!/bin/bash

    [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD="$(< "${REDIS_PASSWORD_FILE}")"
    if [[ -f /opt/bitnami/redis/mounted-etc/master.conf ]];then
        cp /opt/bitnami/redis/mounted-etc/master.conf /opt/bitnami/redis/etc/master.conf
    fi
    if [[ -f /opt/bitnami/redis/mounted-etc/redis.conf ]];then
        cp /opt/bitnami/redis/mounted-etc/redis.conf /opt/bitnami/redis/etc/redis.conf
    fi
    ARGS=("--port" "${REDIS_PORT}")
    ARGS+=("--requirepass" "${REDIS_PASSWORD}")
    ARGS+=("--masterauth" "${REDIS_PASSWORD}")
    ARGS+=("--include" "/opt/bitnami/redis/etc/redis.conf")
    ARGS+=("--include" "/opt/bitnami/redis/etc/master.conf")
    exec redis-server "${ARGS[@]}"
---
# Source: zalf-nextcloud/charts/nextcloud/templates/config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-nextcloud-config
  labels:
    app.kubernetes.io/name: nextcloud
    helm.sh/chart: nextcloud-4.6.4
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
data:
  cron.config.php: |-
    <?php
    $CONFIG = array (
      'maintenance_window_start' => 1,     // run background jobs at 1am
    );
    
  misc.config.php: |-
    <?php
    $CONFIG = array (
      'default_phone_region' => 'DE',
      'overwriteprotocol' => 'https',
      'check_data_directory_permissions' => false,
    );
    
  .htaccess: |-
    # line below if for Apache 2.4
    <ifModule mod_authz_core.c>
    Require all denied
    </ifModule>
    # line below if for Apache 2.2
    <ifModule !mod_authz_core.c>
    deny from all
    </ifModule>
    # section for Apache 2.2 and 2.4
    <ifModule mod_autoindex.c>
    IndexIgnore *
    </ifModule>
  redis.config.php: |-
    <?php
    if (getenv('REDIS_HOST')) {
      $CONFIG = array (
        'memcache.distributed' => '\OC\Memcache\Redis',
        'memcache.locking' => '\OC\Memcache\Redis',
        'redis' => array(
          'host' => getenv('REDIS_HOST'),
          'port' => getenv('REDIS_HOST_PORT') ?: 6379,
          'password' => getenv('REDIS_HOST_PASSWORD'),
        ),
      );
    }
  apache-pretty-urls.config.php: |-
    <?php
    $CONFIG = array (
      'htaccess.RewriteBase' => '/',
    );
  apcu.config.php: |-
    <?php
    $CONFIG = array (
      'memcache.local' => '\OC\Memcache\APCu',
    );
  apps.config.php: |-
    <?php
    $CONFIG = array (
      "apps_paths" => array (
          0 => array (
                  "path"     => OC::$SERVERROOT."/apps",
                  "url"      => "/apps",
                  "writable" => false,
          ),
          1 => array (
                  "path"     => OC::$SERVERROOT."/custom_apps",
                  "url"      => "/custom_apps",
                  "writable" => true,
          ),
      ),
    );
  autoconfig.php: |-
    <?php
    $autoconfig_enabled = false;
    if (getenv('SQLITE_DATABASE')) {
        $AUTOCONFIG["dbtype"] = "sqlite";
        $AUTOCONFIG["dbname"] = getenv('SQLITE_DATABASE');
        $autoconfig_enabled = true;
    } elseif (getenv('MYSQL_DATABASE') && getenv('MYSQL_USER') && getenv('MYSQL_PASSWORD') && getenv('MYSQL_HOST')) {
        $AUTOCONFIG["dbtype"] = "mysql";
        $AUTOCONFIG["dbname"] = getenv('MYSQL_DATABASE');
        $AUTOCONFIG["dbuser"] = getenv('MYSQL_USER');
        $AUTOCONFIG["dbpass"] = getenv('MYSQL_PASSWORD');
        $AUTOCONFIG["dbhost"] = getenv('MYSQL_HOST');
        $autoconfig_enabled = true;
    } elseif (getenv('POSTGRES_DB') && getenv('POSTGRES_USER') && getenv('POSTGRES_PASSWORD') && getenv('POSTGRES_HOST')) {
        $AUTOCONFIG["dbtype"] = "pgsql";
        $AUTOCONFIG["dbname"] = getenv('POSTGRES_DB');
        $AUTOCONFIG["dbuser"] = getenv('POSTGRES_USER');
        $AUTOCONFIG["dbpass"] = getenv('POSTGRES_PASSWORD');
        $AUTOCONFIG["dbhost"] = getenv('POSTGRES_HOST');
        $autoconfig_enabled = true;
    }
    if ($autoconfig_enabled) {
        $AUTOCONFIG["directory"] = getenv('NEXTCLOUD_DATA_DIR') ?: "/var/www/html/data";
    }
  smtp.config.php: |-
    <?php
    if (getenv('SMTP_HOST') && getenv('MAIL_FROM_ADDRESS') && getenv('MAIL_DOMAIN')) {
      $CONFIG = array (
        'mail_smtpmode' => 'smtp',
        'mail_smtphost' => getenv('SMTP_HOST'),
        'mail_smtpport' => getenv('SMTP_PORT') ?: (getenv('SMTP_SECURE') ? 465 : 25),
        'mail_smtpsecure' => getenv('SMTP_SECURE') ?: '',
        'mail_smtpauth' => getenv('SMTP_NAME') && getenv('SMTP_PASSWORD'),
        'mail_smtpauthtype' => getenv('SMTP_AUTHTYPE') ?: 'LOGIN',
        'mail_smtpname' => getenv('SMTP_NAME') ?: '',
        'mail_smtppassword' => getenv('SMTP_PASSWORD') ?: '',
        'mail_from_address' => getenv('MAIL_FROM_ADDRESS'),
        'mail_domain' => getenv('MAIL_DOMAIN'),
      );
    }
---
# Source: zalf-nextcloud/charts/nextcloud/templates/nginx-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-nextcloud-nginxconfig
  labels:
    app.kubernetes.io/name: nextcloud
    helm.sh/chart: nextcloud-4.6.4
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
data:
  default.conf: |-
    upstream php-handler {
        server 127.0.0.1:9000;
    }

    server {
        listen 8080;

        # HSTS settings
        # WARNING: Only add the preload option once you read about
        # the consequences in https://hstspreload.org/. This option
        # will add the domain to a hardcoded list that is shipped
        # in all major browsers and getting removed from this list
        # could take several months.
        #add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload;" always;

        # set max upload size
        client_max_body_size 10G;
        fastcgi_buffers 64 4K;

        # Enable gzip but do not remove ETag headers
        gzip on;
        gzip_vary on;
        gzip_comp_level 4;
        gzip_min_length 256;
        gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;
        gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;

        # Pagespeed is not supported by Nextcloud, so if your server is built
        # with the `ngx_pagespeed` module, uncomment this line to disable it.
        #pagespeed off;

        # HTTP response headers borrowed from Nextcloud `.htaccess`
        add_header Referrer-Policy                      "no-referrer"       always;
        add_header X-Content-Type-Options               "nosniff"           always;
        add_header X-Download-Options                   "noopen"            always;
        add_header X-Frame-Options                      "SAMEORIGIN"        always;
        add_header X-Permitted-Cross-Domain-Policies    "none"              always;
        add_header X-Robots-Tag                         "noindex, nofollow" always;
        add_header X-XSS-Protection                     "1; mode=block"     always;

        # Remove X-Powered-By, which is an information leak
        fastcgi_hide_header X-Powered-By;

        # Add .mjs as a file extension for javascript
        # Either include it in the default mime.types list
        # or include you can include that list explicitly and add the file extension
        # only for Nextcloud like below:
        include mime.types;
        types {
            text/javascript js mjs;
        }        

        # Path to the root of your installation
        root /var/www/html;

        # Specify how to handle directories -- specifying `/index.php$request_uri`
        # here as the fallback means that Nginx always exhibits the desired behaviour
        # when a client requests a path that corresponds to a directory that exists
        # on the server. In particular, if that directory contains an index.php file,
        # that file is correctly served; if it doesn't, then the request is passed to
        # the front-end controller. This consistent behaviour means that we don't need
        # to specify custom rules for certain paths (e.g. images and other assets,
        # `/updater`, `/ocm-provider`, `/ocs-provider`), and thus
        # `try_files $uri $uri/ /index.php$request_uri`
        # always provides the desired behaviour.
        index index.php index.html /index.php$request_uri;

        # Rule borrowed from `.htaccess` to handle Microsoft DAV clients
        location = / {
            if ( $http_user_agent ~ ^DavClnt ) {
                return 302 /remote.php/webdav/$is_args$args;
            }
        }

        location = /robots.txt {
            allow all;
            log_not_found off;
            access_log off;
        }

        # Make a regex exception for `/.well-known` so that clients can still
        # access it despite the existence of the regex rule
        # `location ~ /(\.|autotest|...)` which would otherwise handle requests
        # for `/.well-known`.
        location ^~ /.well-known {
            # The following 6 rules are borrowed from `.htaccess`

            location = /.well-known/carddav     { return 301 /remote.php/dav/; }
            location = /.well-known/caldav      { return 301 /remote.php/dav/; }
            # Anything else is dynamically handled by Nextcloud
            location ^~ /.well-known            { return 301 /index.php$uri; }

            try_files $uri $uri/ =404;
        }

        # Rules borrowed from `.htaccess` to hide certain paths from clients
        location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/)  { return 404; }
        location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console)              { return 404; }

        # Ensure this block, which passes PHP files to the PHP process, is above the blocks
        # which handle static assets (as seen below). If this block is not declared first,
        # then Nginx will encounter an infinite rewriting loop when it prepends `/index.php`
        # to the URI, resulting in a HTTP 500 error response.
        location ~ \.php(?:$|/) {
            # Required for legacy support
            rewrite ^/(?!index|remote|public|cron|core\/ajax\/update|status|ocs\/v[12]|updater\/.+|oc[ms]-provider\/.+|.+\/richdocumentscode(_arm64)?\/proxy) /index.php$request_uri;

            fastcgi_split_path_info ^(.+?\.php)(/.*)$;
            set $path_info $fastcgi_path_info;

            try_files $fastcgi_script_name =404;

            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $path_info;
            #fastcgi_param HTTPS on;

            fastcgi_param modHeadersAvailable true;         # Avoid sending the security headers twice
            fastcgi_param front_controller_active true;     # Enable pretty urls
            fastcgi_pass php-handler;

            fastcgi_intercept_errors on;
            fastcgi_request_buffering off;
        }

        location ~ \.(?:css|js|svg|gif)$ {
            try_files $uri /index.php$request_uri;
            expires 6M;         # Cache-Control policy borrowed from `.htaccess`
            access_log off;     # Optional: Don't log access to assets
        }

        location ~ \.woff2?$ {
            try_files $uri /index.php$request_uri;
            expires 7d;         # Cache-Control policy borrowed from `.htaccess`
            access_log off;     # Optional: Don't log access to assets
        }

        location / {
            try_files $uri $uri/ /index.php$request_uri;
        }
    }
  zz-custom.conf: |-
    types {
      text/javascript mjs;
    }
---
# Source: zalf-nextcloud/templates/additional-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-additional-config
data:
  proxy.config.php: |
    <?php
    $CONFIG = array (
      'trusted_proxies' => array(
        0 => '127.0.0.1',
        1 => '172.16.64.0/18',
      ),
      'forwarded_for_headers' => array('HTTP_X_FORWARDED_FOR'),
    );
  redis-session.ini: |
    session.save_handler = redis
    session.save_path = "tcp://test-redis-master:6379?auth=willTHEfragmatismwane2towardsthe3quantumlogician."
    redis.session.locking_enabled = 1
    redis.session.lock_retries = -1
    redis.session.lock_wait_time = 10000
  php-fpm-www.conf: |
    ; Start a new pool named 'www'.
    ; the variable $pool can be used in any directive and will be replaced by the
    ; pool name ('www' here)
    [www]

    ; Per pool prefix
    ; It only applies on the following directives:
    ; - 'access.log'
    ; - 'slowlog'
    ; - 'listen' (unixsocket)
    ; - 'chroot'
    ; - 'chdir'
    ; - 'php_values'
    ; - 'php_admin_values'
    ; When not set, the global prefix (or NONE) applies instead.
    ; Note: This directive can also be relative to the global prefix.
    ; Default Value: none
    ;prefix = /path/to/pools/$pool

    ; Unix user/group of the child processes. This can be used only if the master
    ; process running user is root. It is set after the child process is created.
    ; The user and group can be specified either by their name or by their numeric
    ; IDs.
    ; Note: If the user is root, the executable needs to be started with
    ;       --allow-to-run-as-root option to work.
    ; Default Values: The user is set to master process running user by default.
    ;                 If the group is not set, the user's group is used.
    user = www-data
    group = www-data

    ; The address on which to accept FastCGI requests.
    ; Valid syntaxes are:
    ;   'ip.add.re.ss:port'    - to listen on a TCP socket to a specific IPv4 address on
    ;                            a specific port;
    ;   '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on
    ;                            a specific port;
    ;   'port'                 - to listen on a TCP socket to all addresses
    ;                            (IPv6 and IPv4-mapped) on a specific port;
    ;   '/path/to/unix/socket' - to listen on a unix socket.
    ; Note: This value is mandatory.
    listen = 127.0.0.1:9000

    ; Set listen(2) backlog.
    ; Default Value: 511 (-1 on Linux, FreeBSD and OpenBSD)
    ;listen.backlog = 511

    ; Set permissions for unix socket, if one is used. In Linux, read/write
    ; permissions must be set in order to allow connections from a web server. Many
    ; BSD-derived systems allow connections regardless of permissions. The owner
    ; and group can be specified either by name or by their numeric IDs.
    ; Default Values: Owner is set to the master process running user. If the group
    ;                 is not set, the owner's group is used. Mode is set to 0660.
    ;listen.owner = www-data
    ;listen.group = www-data
    ;listen.mode = 0660

    ; When POSIX Access Control Lists are supported you can set them using
    ; these options, value is a comma separated list of user/group names.
    ; When set, listen.owner and listen.group are ignored
    ;listen.acl_users =
    ;listen.acl_groups =

    ; List of addresses (IPv4/IPv6) of FastCGI clients which are allowed to connect.
    ; Equivalent to the FCGI_WEB_SERVER_ADDRS environment variable in the original
    ; PHP FCGI (5.2.2+). Makes sense only with a tcp listening socket. Each address
    ; must be separated by a comma. If this value is left blank, connections will be
    ; accepted from any ip address.
    ; Default Value: any
    ;listen.allowed_clients = 127.0.0.1

    ; Set the associated the route table (FIB). FreeBSD only
    ; Default Value: -1
    ;listen.setfib = 1

    ; Specify the nice(2) priority to apply to the pool processes (only if set)
    ; The value can vary from -19 (highest priority) to 20 (lower priority)
    ; Note: - It will only work if the FPM master process is launched as root
    ;       - The pool processes will inherit the master process priority
    ;         unless it specified otherwise
    ; Default Value: no set
    ; process.priority = -19

    ; Set the process dumpable flag (PR_SET_DUMPABLE prctl for Linux or
    ; PROC_TRACE_CTL procctl for FreeBSD) even if the process user
    ; or group is different than the master process user. It allows to create process
    ; core dump and ptrace the process for the pool user.
    ; Default Value: no
    ; process.dumpable = yes

    ; Choose how the process manager will control the number of child processes.
    ; Possible Values:
    ;   static  - a fixed number (pm.max_children) of child processes;
    ;   dynamic - the number of child processes are set dynamically based on the
    ;             following directives. With this process management, there will be
    ;             always at least 1 children.
    ;             pm.max_children      - the maximum number of children that can
    ;                                    be alive at the same time.
    ;             pm.start_servers     - the number of children created on startup.
    ;             pm.min_spare_servers - the minimum number of children in 'idle'
    ;                                    state (waiting to process). If the number
    ;                                    of 'idle' processes is less than this
    ;                                    number then some children will be created.
    ;             pm.max_spare_servers - the maximum number of children in 'idle'
    ;                                    state (waiting to process). If the number
    ;                                    of 'idle' processes is greater than this
    ;                                    number then some children will be killed.
    ;             pm.max_spawn_rate    - the maximum number of rate to spawn child
    ;                                    processes at once.
    ;  ondemand - no children are created at startup. Children will be forked when
    ;             new requests will connect. The following parameter are used:
    ;             pm.max_children           - the maximum number of children that
    ;                                         can be alive at the same time.
    ;             pm.process_idle_timeout   - The number of seconds after which
    ;                                         an idle process will be killed.
    ; Note: This value is mandatory.
    pm = dynamic

    ; The number of child processes to be created when pm is set to 'static' and the
    ; maximum number of child processes when pm is set to 'dynamic' or 'ondemand'.
    ; This value sets the limit on the number of simultaneous requests that will be
    ; served. Equivalent to the ApacheMaxClients directive with mpm_prefork.
    ; Equivalent to the PHP_FCGI_CHILDREN environment variable in the original PHP
    ; CGI. The below defaults are based on a server without much resources. Don't
    ; forget to tweak pm.* to fit your needs.
    ; Note: Used when pm is set to 'static', 'dynamic' or 'ondemand'
    ; Note: This value is mandatory.
    pm.max_children = 12

    ; The number of child processes created on startup.
    ; Note: Used only when pm is set to 'dynamic'
    ; Default Value: (min_spare_servers + max_spare_servers) / 2
    pm.start_servers = 8

    ; The desired minimum number of idle server processes.
    ; Note: Used only when pm is set to 'dynamic'
    ; Note: Mandatory when pm is set to 'dynamic'
    pm.min_spare_servers = 4

    ; The desired maximum number of idle server processes.
    ; Note: Used only when pm is set to 'dynamic'
    ; Note: Mandatory when pm is set to 'dynamic'
    pm.max_spare_servers = 12

    ; The number of rate to spawn child processes at once.
    ; Note: Used only when pm is set to 'dynamic'
    ; Note: Mandatory when pm is set to 'dynamic'
    ; Default Value: 32
    ;pm.max_spawn_rate = 32

    ; The number of seconds after which an idle process will be killed.
    ; Note: Used only when pm is set to 'ondemand'
    ; Default Value: 10s
    ;pm.process_idle_timeout = 10s;

    ; The number of requests each child process should execute before respawning.
    ; This can be useful to work around memory leaks in 3rd party libraries. For
    ; endless request processing specify '0'. Equivalent to PHP_FCGI_MAX_REQUESTS.
    ; Default Value: 0
    ;pm.max_requests = 500

    ; The URI to view the FPM status page. If this value is not set, no URI will be
    ; recognized as a status page. It shows the following information:
    ;   pool                 - the name of the pool;
    ;   process manager      - static, dynamic or ondemand;
    ;   start time           - the date and time FPM has started;
    ;   start since          - number of seconds since FPM has started;
    ;   accepted conn        - the number of request accepted by the pool;
    ;   listen queue         - the number of request in the queue of pending
    ;                          connections (see backlog in listen(2));
    ;   max listen queue     - the maximum number of requests in the queue
    ;                          of pending connections since FPM has started;
    ;   listen queue len     - the size of the socket queue of pending connections;
    ;   idle processes       - the number of idle processes;
    ;   active processes     - the number of active processes;
    ;   total processes      - the number of idle + active processes;
    ;   max active processes - the maximum number of active processes since FPM
    ;                          has started;
    ;   max children reached - number of times, the process limit has been reached,
    ;                          when pm tries to start more children (works only for
    ;                          pm 'dynamic' and 'ondemand');
    ; Value are updated in real time.
    ; Example output:
    ;   pool:                 www
    ;   process manager:      static
    ;   start time:           01/Jul/2011:17:53:49 +0200
    ;   start since:          62636
    ;   accepted conn:        190460
    ;   listen queue:         0
    ;   max listen queue:     1
    ;   listen queue len:     42
    ;   idle processes:       4
    ;   active processes:     11
    ;   total processes:      15
    ;   max active processes: 12
    ;   max children reached: 0
    ;
    ; By default the status page output is formatted as text/plain. Passing either
    ; 'html', 'xml' or 'json' in the query string will return the corresponding
    ; output syntax. Example:
    ;   http://www.foo.bar/status
    ;   http://www.foo.bar/status?json
    ;   http://www.foo.bar/status?html
    ;   http://www.foo.bar/status?xml
    ;
    ; By default the status page only outputs short status. Passing 'full' in the
    ; query string will also return status for each pool process.
    ; Example:
    ;   http://www.foo.bar/status?full
    ;   http://www.foo.bar/status?json&full
    ;   http://www.foo.bar/status?html&full
    ;   http://www.foo.bar/status?xml&full
    ; The Full status returns for each process:
    ;   pid                  - the PID of the process;
    ;   state                - the state of the process (Idle, Running, ...);
    ;   start time           - the date and time the process has started;
    ;   start since          - the number of seconds since the process has started;
    ;   requests             - the number of requests the process has served;
    ;   request duration     - the duration in Âµs of the requests;
    ;   request method       - the request method (GET, POST, ...);
    ;   request URI          - the request URI with the query string;
    ;   content length       - the content length of the request (only with POST);
    ;   user                 - the user (PHP_AUTH_USER) (or '-' if not set);
    ;   script               - the main script called (or '-' if not set);
    ;   last request cpu     - the %cpu the last request consumed
    ;                          it's always 0 if the process is not in Idle state
    ;                          because CPU calculation is done when the request
    ;                          processing has terminated;
    ;   last request memory  - the max amount of memory the last request consumed
    ;                          it's always 0 if the process is not in Idle state
    ;                          because memory calculation is done when the request
    ;                          processing has terminated;
    ; If the process is in Idle state, then informations are related to the
    ; last request the process has served. Otherwise informations are related to
    ; the current request being served.
    ; Example output:
    ;   ************************
    ;   pid:                  31330
    ;   state:                Running
    ;   start time:           01/Jul/2011:17:53:49 +0200
    ;   start since:          63087
    ;   requests:             12808
    ;   request duration:     1250261
    ;   request method:       GET
    ;   request URI:          /test_mem.php?N=10000
    ;   content length:       0
    ;   user:                 -
    ;   script:               /home/fat/web/docs/php/test_mem.php
    ;   last request cpu:     0.00
    ;   last request memory:  0
    ;
    ; Note: There is a real-time FPM status monitoring sample web page available
    ;       It's available in: /usr/local/share/php/fpm/status.html
    ;
    ; Note: The value must start with a leading slash (/). The value can be
    ;       anything, but it may not be a good idea to use the .php extension or it
    ;       may conflict with a real PHP file.
    ; Default Value: not set
    ;pm.status_path = /status

    ; The address on which to accept FastCGI status request. This creates a new
    ; invisible pool that can handle requests independently. This is useful
    ; if the main pool is busy with long running requests because it is still possible
    ; to get the status before finishing the long running requests.
    ;
    ; Valid syntaxes are:
    ;   'ip.add.re.ss:port'    - to listen on a TCP socket to a specific IPv4 address on
    ;                            a specific port;
    ;   '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on
    ;                            a specific port;
    ;   'port'                 - to listen on a TCP socket to all addresses
    ;                            (IPv6 and IPv4-mapped) on a specific port;
    ;   '/path/to/unix/socket' - to listen on a unix socket.
    ; Default Value: value of the listen option
    ;pm.status_listen = 127.0.0.1:9001

    ; The ping URI to call the monitoring page of FPM. If this value is not set, no
    ; URI will be recognized as a ping page. This could be used to test from outside
    ; that FPM is alive and responding, or to
    ; - create a graph of FPM availability (rrd or such);
    ; - remove a server from a group if it is not responding (load balancing);
    ; - trigger alerts for the operating team (24/7).
    ; Note: The value must start with a leading slash (/). The value can be
    ;       anything, but it may not be a good idea to use the .php extension or it
    ;       may conflict with a real PHP file.
    ; Default Value: not set
    ;ping.path = /ping

    ; This directive may be used to customize the response of a ping request. The
    ; response is formatted as text/plain with a 200 response code.
    ; Default Value: pong
    ;ping.response = pong

    ; The access log file
    ; Default: not set
    ;access.log = log/$pool.access.log

    ; The access log format.
    ; The following syntax is allowed
    ;  %%: the '%' character
    ;  %C: %CPU used by the request
    ;      it can accept the following format:
    ;      - %{user}C for user CPU only
    ;      - %{system}C for system CPU only
    ;      - %{total}C  for user + system CPU (default)
    ;  %d: time taken to serve the request
    ;      it can accept the following format:
    ;      - %{seconds}d (default)
    ;      - %{milliseconds}d
    ;      - %{milli}d
    ;      - %{microseconds}d
    ;      - %{micro}d
    ;  %e: an environment variable (same as $_ENV or $_SERVER)
    ;      it must be associated with embraces to specify the name of the env
    ;      variable. Some examples:
    ;      - server specifics like: %{REQUEST_METHOD}e or %{SERVER_PROTOCOL}e
    ;      - HTTP headers like: %{HTTP_HOST}e or %{HTTP_USER_AGENT}e
    ;  %f: script filename
    ;  %l: content-length of the request (for POST request only)
    ;  %m: request method
    ;  %M: peak of memory allocated by PHP
    ;      it can accept the following format:
    ;      - %{bytes}M (default)
    ;      - %{kilobytes}M
    ;      - %{kilo}M
    ;      - %{megabytes}M
    ;      - %{mega}M
    ;  %n: pool name
    ;  %o: output header
    ;      it must be associated with embraces to specify the name of the header:
    ;      - %{Content-Type}o
    ;      - %{X-Powered-By}o
    ;      - %{Transfert-Encoding}o
    ;      - ....
    ;  %p: PID of the child that serviced the request
    ;  %P: PID of the parent of the child that serviced the request
    ;  %q: the query string
    ;  %Q: the '?' character if query string exists
    ;  %r: the request URI (without the query string, see %q and %Q)
    ;  %R: remote IP address
    ;  %s: status (response code)
    ;  %t: server time the request was received
    ;      it can accept a strftime(3) format:
    ;      %d/%b/%Y:%H:%M:%S %z (default)
    ;      The strftime(3) format must be encapsulated in a %{<strftime_format>}t tag
    ;      e.g. for a ISO8601 formatted timestring, use: %{%Y-%m-%dT%H:%M:%S%z}t
    ;  %T: time the log has been written (the request has finished)
    ;      it can accept a strftime(3) format:
    ;      %d/%b/%Y:%H:%M:%S %z (default)
    ;      The strftime(3) format must be encapsulated in a %{<strftime_format>}t tag
    ;      e.g. for a ISO8601 formatted timestring, use: %{%Y-%m-%dT%H:%M:%S%z}t
    ;  %u: remote user
    ;
    ; Default: "%R - %u %t \"%m %r\" %s"
    ;access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{milli}d %{kilo}M %C%%"

    ; A list of request_uri values which should be filtered from the access log.
    ;
    ; As a security precuation, this setting will be ignored if:
    ;     - the request method is not GET or HEAD; or
    ;     - there is a request body; or
    ;     - there are query parameters; or
    ;     - the response code is outwith the successful range of 200 to 299
    ;
    ; Note: The paths are matched against the output of the access.format tag "%r".
    ;       On common configurations, this may look more like SCRIPT_NAME than the
    ;       expected pre-rewrite URI.
    ;
    ; Default Value: not set
    ;access.suppress_path[] = /ping
    ;access.suppress_path[] = /health_check.php

    ; The log file for slow requests
    ; Default Value: not set
    ; Note: slowlog is mandatory if request_slowlog_timeout is set
    ;slowlog = log/$pool.log.slow

    ; The timeout for serving a single request after which a PHP backtrace will be
    ; dumped to the 'slowlog' file. A value of '0s' means 'off'.
    ; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)
    ; Default Value: 0
    ;request_slowlog_timeout = 0

    ; Depth of slow log stack trace.
    ; Default Value: 20
    ;request_slowlog_trace_depth = 20

    ; The timeout for serving a single request after which the worker process will
    ; be killed. This option should be used when the 'max_execution_time' ini option
    ; does not stop script execution for some reason. A value of '0' means 'off'.
    ; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)
    ; Default Value: 0
    ;request_terminate_timeout = 0

    ; The timeout set by 'request_terminate_timeout' ini option is not engaged after
    ; application calls 'fastcgi_finish_request' or when application has finished and
    ; shutdown functions are being called (registered via register_shutdown_function).
    ; This option will enable timeout limit to be applied unconditionally
    ; even in such cases.
    ; Default Value: no
    ;request_terminate_timeout_track_finished = no

    ; Set open file descriptor rlimit.
    ; Default Value: system defined value
    ;rlimit_files = 1024

    ; Set max core size rlimit.
    ; Possible Values: 'unlimited' or an integer greater or equal to 0
    ; Default Value: system defined value
    ;rlimit_core = 0

    ; Chroot to this directory at the start. This value must be defined as an
    ; absolute path. When this value is not set, chroot is not used.
    ; Note: you can prefix with '$prefix' to chroot to the pool prefix or one
    ; of its subdirectories. If the pool prefix is not set, the global prefix
    ; will be used instead.
    ; Note: chrooting is a great security feature and should be used whenever
    ;       possible. However, all PHP paths will be relative to the chroot
    ;       (error_log, sessions.save_path, ...).
    ; Default Value: not set
    ;chroot =

    ; Chdir to this directory at the start.
    ; Note: relative path can be used.
    ; Default Value: current directory or / when chroot
    ;chdir = /var/www

    ; Redirect worker stdout and stderr into main error log. If not set, stdout and
    ; stderr will be redirected to /dev/null according to FastCGI specs.
    ; Note: on highloaded environment, this can cause some delay in the page
    ; process time (several ms).
    ; Default Value: no
    ;catch_workers_output = yes

    ; Decorate worker output with prefix and suffix containing information about
    ; the child that writes to the log and if stdout or stderr is used as well as
    ; log level and time. This options is used only if catch_workers_output is yes.
    ; Settings to "no" will output data as written to the stdout or stderr.
    ; Default value: yes
    ;decorate_workers_output = no

    ; Clear environment in FPM workers
    ; Prevents arbitrary environment variables from reaching FPM worker processes
    ; by clearing the environment in workers before env vars specified in this
    ; pool configuration are added.
    ; Setting to "no" will make all environment variables available to PHP code
    ; via getenv(), $_ENV and $_SERVER.
    ; Default Value: yes
    ;clear_env = no

    ; Limits the extensions of the main script FPM will allow to parse. This can
    ; prevent configuration mistakes on the web server side. You should only limit
    ; FPM to .php extensions to prevent malicious users to use other extensions to
    ; execute php code.
    ; Note: set an empty value to allow all extensions.
    ; Default Value: .php
    ;security.limit_extensions = .php .php3 .php4 .php5 .php7

    ; Pass environment variables like LD_LIBRARY_PATH. All $VARIABLEs are taken from
    ; the current environment.
    ; Default Value: clean env
    ;env[HOSTNAME] = $HOSTNAME
    ;env[PATH] = /usr/local/bin:/usr/bin:/bin
    ;env[TMP] = /tmp
    ;env[TMPDIR] = /tmp
    ;env[TEMP] = /tmp

    ; Additional php.ini defines, specific to this pool of workers. These settings
    ; overwrite the values previously defined in the php.ini. The directives are the
    ; same as the PHP SAPI:
    ;   php_value/php_flag             - you can set classic ini defines which can
    ;                                    be overwritten from PHP call 'ini_set'.
    ;   php_admin_value/php_admin_flag - these directives won't be overwritten by
    ;                                     PHP call 'ini_set'
    ; For php_*flag, valid values are on, off, 1, 0, true, false, yes or no.

    ; Defining 'extension' will load the corresponding shared extension from
    ; extension_dir. Defining 'disable_functions' or 'disable_classes' will not
    ; overwrite previously defined php.ini values, but will append the new value
    ; instead.

    ; Note: path INI options can be relative and will be expanded with the prefix
    ; (pool, global or /usr/local)

    ; Default Value: nothing is defined by default except the values in php.ini and
    ;                specified at startup with the -d argument
    ;php_admin_value[sendmail_path] = /usr/sbin/sendmail -t -i -f www@my.domain.com
    ;php_flag[display_errors] = off
    ;php_admin_value[error_log] = /var/log/fpm-php.www.log
    ;php_admin_flag[log_errors] = on
    ;php_admin_value[memory_limit] = 32M
---
# Source: zalf-nextcloud/templates/installation-scripts.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-installation-scripts
data:
  wait-for-postgresql.sh: |
    #!/usr/bin/env sh

    php_code=$(cat <<'EOF'
    // Database connection string
    $dsn = "pgsql:host=" . $_ENV['POSTGRES_HOST'] . ";dbname=" . $_ENV['POSTGRES_DB'] . ";user=" . $_ENV['POSTGRES_USER'] . ";password=" . $_ENV['POSTGRES_PASSWORD'];
    // Maximum number of connection attempts
    $max_attempts = 300;

    $attempt = 1;
    $connected = false;
    // Wait until the database is ready
    while (!$connected && $attempt <= $max_attempts) {
      try {
        $pdo = new PDO($dsn);
        $connected = true;
        echo "Successfully connected to the postgresql database";
      } catch (PDOException $e) {
        sleep(1);
        $attempt++;
      }
    }

    if (!$connected) {
      echo "Failure to connect to the postgresql database";
      exit(1);
    }
    EOF
    )

    php -r "$php_code"
  post-installation.sh: |
    #!/usr/bin/env sh

    # install NextcloudOffice plugin
    php /var/www/html/occ app:install richdocuments

    # Set allowed CollaboraOffice hosts to talk to nextcloud
    
    php /var/www/html/occ config:app:set richdocuments wopi_url --value=https://collabora.fairagro.net:443
    php /var/www/html/occ config:app:set richdocuments wopi_allowlist --value=161.97.79.221

    # add missing database indices
    php /var/www/html/occ db:add-missing-indices
---
# Source: zalf-nextcloud/charts/nextcloud/templates/nextcloud-data-pvc.yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: test-nextcloud-nextcloud-data
  labels:
    app.kubernetes.io/name: nextcloud
    helm.sh/chart: nextcloud-4.6.4
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: app
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: "100Gi"
  storageClassName: "nfs-csi-delete"
---
# Source: zalf-nextcloud/charts/nextcloud/templates/nextcloud-pvc.yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: test-nextcloud-nextcloud
  labels:
    app.kubernetes.io/name: nextcloud
    helm.sh/chart: nextcloud-4.6.4
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: app
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: "4Gi"
  storageClassName: "nfs-csi-delete"
---
# Source: zalf-nextcloud/charts/collabora-online/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-collabora-online
  labels:
    helm.sh/chart: collabora-online-1.1.11
    app.kubernetes.io/name: collabora-online
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "23.05.8.4.1"
    app.kubernetes.io/managed-by: Helm
    type: main
spec:
  type: ClusterIP
  ports:
    - port: 9980
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: collabora-online
    app.kubernetes.io/instance: test
    type: main
---
# Source: zalf-nextcloud/charts/fairagro-onlyoffice/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-fairagro-onlyoffice
  labels:
    helm.sh/chart: fairagro-onlyoffice-0.1.0
    app.kubernetes.io/name: fairagro-onlyoffice
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "8.0.1"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: fairagro-onlyoffice
    app.kubernetes.io/instance: test
---
# Source: zalf-nextcloud/charts/nextcloud/charts/redis/templates/headless-svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-redis-headless
  namespace: "fairagro-keycloak"
  labels:
    app.kubernetes.io/name: redis
    helm.sh/chart: redis-17.13.2
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
  annotations:
    
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: tcp-redis
      port: 6379
      targetPort: redis
  selector:
    app.kubernetes.io/name: redis
    app.kubernetes.io/instance: test
---
# Source: zalf-nextcloud/charts/nextcloud/charts/redis/templates/master/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-redis-master
  namespace: "fairagro-keycloak"
  labels:
    app.kubernetes.io/name: redis
    helm.sh/chart: redis-17.13.2
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: master
spec:
  type: ClusterIP
  internalTrafficPolicy: Cluster
  sessionAffinity: None
  ports:
    - name: tcp-redis
      port: 6379
      targetPort: redis
      nodePort: null
  selector:
    app.kubernetes.io/name: redis
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: master
---
# Source: zalf-nextcloud/charts/nextcloud/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-nextcloud
  labels:
    app.kubernetes.io/name: nextcloud
    helm.sh/chart: nextcloud-4.6.4
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: app
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: nextcloud
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: app
---
# Source: zalf-nextcloud/charts/collabora-online/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-collabora-online
  labels:
    helm.sh/chart: collabora-online-1.1.11
    app.kubernetes.io/name: collabora-online
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "23.05.8.4.1"
    app.kubernetes.io/managed-by: Helm
spec:
  minReadySeconds: 0
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: collabora-online
      app.kubernetes.io/instance: test
      type: main
  template:
    metadata:
      annotations:
        confighash: config-e8e504528cedfc6fafb09089c7254be4
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
      labels:
        app.kubernetes.io/name: collabora-online
        app.kubernetes.io/instance: test
        type: main
    spec:
      terminationGracePeriodSeconds: 60
      serviceAccountName: default
      securityContext:
        {}
      containers:
        - name: collabora-online
          securityContext:
            privileged: true
          image: "collabora/code@sha256:e0c7ff3cf4ccd49a590980cf83f46f8efd9456f9d173f92d1acfd3f41be09319"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 9980
              protocol: TCP
          startupProbe:
            httpGet:
              path: /
              port: 9980
              scheme: HTTP
            failureThreshold: 30
            periodSeconds: 3
          livenessProbe:
            httpGet:
              path: /
              port: 9980
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 30
            successThreshold: 1
            failureThreshold: 4
          readinessProbe:
            httpGet:
              path: /
              port: 9980
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 30
            successThreshold: 1
            failureThreshold: 2

          envFrom:
            - configMapRef:
                name: test-collabora-online
          env:
            - name: username
              valueFrom:
                secretKeyRef:
                  name: test-collabora-online
                  key: username
            - name: password
              valueFrom:
                secretKeyRef:
                  name: test-collabora-online
                  key: password
          resources:
            limits:
              cpu: "8"
              memory: 8Gi
            requests:
              cpu: "4"
              memory: 6Gi
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
---
# Source: zalf-nextcloud/charts/fairagro-onlyoffice/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-fairagro-onlyoffice
  labels:
    helm.sh/chart: fairagro-onlyoffice-0.1.0
    app.kubernetes.io/name: fairagro-onlyoffice
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "8.0.1"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: fairagro-onlyoffice
      app.kubernetes.io/instance: test
  template:
    metadata:
      labels:
        helm.sh/chart: fairagro-onlyoffice-0.1.0
        app.kubernetes.io/name: fairagro-onlyoffice
        app.kubernetes.io/instance: test
        app.kubernetes.io/version: "8.0.1"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: test-fairagro-onlyoffice
      securityContext:
        {}
      containers:
        - name: fairagro-onlyoffice
          securityContext:
            {}
          image: onlyoffice/documentserver@sha256:5ed447a097b368e97de8c25ba5ef53c425acfa1bb084e33b8a0de4a7a1e2099c
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          resources:
            {}
          env:
            - name: DB_TYPE
              value: postgres
            - name: DB_HOST
              value: test-fairagro-onlyoffice-postgresql
            - name: DB_PORT
              value: "5432"
            - name: DB_NAME
              value: onlyoffice
            - name: DB_USER
              valueFrom:
                name: onlyoffice.test-fairagro-onlyoffice-postgresql.credentials.postgresql.acid.zalan.do
                key: username
            - name: DB_PWD
              valueFrom:
                name: onlyoffice.test-fairagro-onlyoffice-postgresql.credentials.postgresql.acid.zalan.do
                key: password
            - name: JWT_ENABLED
              value: false
          volumeMounts:
            - mountPath: /var/lib/onlyoffice
              name: file-cache
      volumes:
        - emptyDir:
            sizeLimit: 1Gi
          name: file-cache
---
# Source: zalf-nextcloud/charts/nextcloud/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-nextcloud
  labels:
    app.kubernetes.io/name: nextcloud
    helm.sh/chart: nextcloud-4.6.4
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: app
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: nextcloud
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: app
  template:
    metadata:
      labels:
        app.kubernetes.io/name: nextcloud
        app.kubernetes.io/instance: test
        app.kubernetes.io/component: app
        test-redis-client: "true"
      annotations:
        nextcloud-config-hash: 65cf0d00562a788c95421b2ff6a6752018becbcbac30deed6dbf065eacf1a697
        php-config-hash: 44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a
        nginx-config-hash: 6bcad82106899ee90cd20226d537a68ca1b8be571f14f86f1967d252c1c20326
        hooks-hash: 44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a
    spec:
      containers:
        - name: nextcloud
          image: nextcloud@sha256:d0d13d935eaa9219bfa89fd8213b3ede6431e04685f0a25f6f764f5e5dcfe990
          imagePullPolicy: IfNotPresent
          env:
            
            - name: POSTGRES_HOST
              value: "fairagro-postgresql-nextcloud"
            - name: POSTGRES_DB
              value: "nextcloud"
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: nextcloud.fairagro-postgresql-nextcloud.credentials.postgresql.acid.zalan.do
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nextcloud.fairagro-postgresql-nextcloud.credentials.postgresql.acid.zalan.do
                  key: password
            - name: NEXTCLOUD_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: nextcloud-username
            - name: NEXTCLOUD_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: nextcloud-password
            - name: NEXTCLOUD_TRUSTED_DOMAINS
              value: nextcloud.fairagro.net
            - name: NEXTCLOUD_DATA_DIR
              value: "/nextcloud_data"
            - name: MAIL_FROM_ADDRESS
              value: "nextcloud"
            - name: MAIL_DOMAIN
              value: "fairagro.net"
            - name: SMTP_SECURE
              value: "starttls"
            - name: SMTP_PORT
              value: "587"
            - name: SMTP_AUTHTYPE
              value: "LOGIN"
            - name: SMTP_HOST
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: smtp-host
            - name: SMTP_NAME
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: smtp-username
            - name: SMTP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: smtp-password
            - name: REDIS_HOST
              value: test-redis-master
            - name: REDIS_HOST_PORT
              value: "6379"
            - name: REDIS_HOST_PASSWORD
              value: willTHEfragmatismwane2towardsthe3quantumlogician.
            - name: PGSSLCERT
              value: /tmp/postgresql.crt
          resources:
            limits:
              cpu: "4"
              memory: 8Gi
            requests:
              cpu: "2"
              memory: 6Gi
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: false
            runAsGroup: 82
            runAsNonRoot: true
            runAsUser: 82
          volumeMounts:
            - name: nextcloud-main
              mountPath: /var/www/
              subPath: root
            - name: nextcloud-main
              mountPath: /var/www/html
              subPath: html
            - name: nextcloud-data
              mountPath: /nextcloud_data
              subPath: data
            - name: nextcloud-main
              mountPath: /var/www/html/config
              subPath: config
            - name: nextcloud-main
              mountPath: /var/www/html/custom_apps
              subPath: custom_apps
            - name: nextcloud-main
              mountPath: /var/www/tmp
              subPath: tmp
            - name: nextcloud-main
              mountPath: /var/www/html/themes
              subPath: themes
            - name: nextcloud-config
              mountPath: /var/www/html/config/cron.config.php
              subPath: cron.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/misc.config.php
              subPath: misc.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/.htaccess
              subPath: .htaccess
            - name: nextcloud-config
              mountPath: /var/www/html/config/apache-pretty-urls.config.php
              subPath: apache-pretty-urls.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/apcu.config.php
              subPath: apcu.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/apps.config.php
              subPath: apps.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/autoconfig.php
              subPath: autoconfig.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/redis.config.php
              subPath: redis.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/smtp.config.php
              subPath: smtp.config.php
            - mountPath: /docker-entrypoint-hooks.d/post-installation/post-installation.sh
              name: installation-scripts
              readOnly: true
              subPath: post-installation.sh
            - mountPath: /docker-entrypoint-hooks.d/pre-installation/wait-for-postgresql.sh
              name: installation-scripts
              readOnly: true
              subPath: wait-for-postgresql.sh
            - mountPath: /var/www/html/config/proxy.config.php
              name: additional-config
              subPath: proxy.config.php
            - mountPath: /usr/local/etc/php/conf.d/redis-session.ini
              name: additional-config
              subPath: redis-session.ini
            - mountPath: /usr/local/etc/php-fpm.d/www.conf
              name: additional-config
              subPath: php-fpm-www.conf
        - name: nextcloud-nginx
          image: "nginxinc/nginx-unprivileged@sha256:a2e2a031969b6fc6107537901a04c354b38e1708ba3a5e1042b390277b55780e"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              protocol: TCP
              containerPort: 8080
          livenessProbe:
            httpGet:
              path: /status.php
              port:  8080
              httpHeaders:
                - name: Host
                  value: "nextcloud.fairagro.net"
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /status.php
              port:  8080
              httpHeaders:
                - name: Host
                  value: "nextcloud.fairagro.net"
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /status.php
              port:  8080
              httpHeaders:
                - name: Host
                  value: "nextcloud.fairagro.net"
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 300

          resources:
            limits:
              cpu: "2"
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 200Mi
          volumeMounts:
            - name: nextcloud-main
              mountPath: /var/www/
              subPath: root
            - name: nextcloud-main
              mountPath: /var/www/html
              subPath: html
            - name: nextcloud-data
              mountPath: /nextcloud_data
              subPath: data
            - name: nextcloud-main
              mountPath: /var/www/html/config
              subPath: config
            - name: nextcloud-main
              mountPath: /var/www/html/custom_apps
              subPath: custom_apps
            - name: nextcloud-main
              mountPath: /var/www/tmp
              subPath: tmp
            - name: nextcloud-main
              mountPath: /var/www/html/themes
              subPath: themes
            - name: nextcloud-nginx-config
              mountPath: /etc/nginx/conf.d/
            - mountPath: /docker-entrypoint-hooks.d/post-installation/post-installation.sh
              name: installation-scripts
              readOnly: true
              subPath: post-installation.sh
            - mountPath: /docker-entrypoint-hooks.d/pre-installation/wait-for-postgresql.sh
              name: installation-scripts
              readOnly: true
              subPath: wait-for-postgresql.sh
            - mountPath: /var/www/html/config/proxy.config.php
              name: additional-config
              subPath: proxy.config.php
            - mountPath: /usr/local/etc/php/conf.d/redis-session.ini
              name: additional-config
              subPath: redis-session.ini
            - mountPath: /usr/local/etc/php-fpm.d/www.conf
              name: additional-config
              subPath: php-fpm-www.conf
        - name: nextcloud-cron
          image: nextcloud@sha256:d0d13d935eaa9219bfa89fd8213b3ede6431e04685f0a25f6f764f5e5dcfe990
          imagePullPolicy: IfNotPresent
          command:
            - /cron.sh
          env:
            
            - name: POSTGRES_HOST
              value: "fairagro-postgresql-nextcloud"
            - name: POSTGRES_DB
              value: "nextcloud"
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: nextcloud.fairagro-postgresql-nextcloud.credentials.postgresql.acid.zalan.do
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nextcloud.fairagro-postgresql-nextcloud.credentials.postgresql.acid.zalan.do
                  key: password
            - name: NEXTCLOUD_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: nextcloud-username
            - name: NEXTCLOUD_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: nextcloud-password
            - name: NEXTCLOUD_TRUSTED_DOMAINS
              value: nextcloud.fairagro.net
            - name: NEXTCLOUD_DATA_DIR
              value: "/nextcloud_data"
            - name: MAIL_FROM_ADDRESS
              value: "nextcloud"
            - name: MAIL_DOMAIN
              value: "fairagro.net"
            - name: SMTP_SECURE
              value: "starttls"
            - name: SMTP_PORT
              value: "587"
            - name: SMTP_AUTHTYPE
              value: "LOGIN"
            - name: SMTP_HOST
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: smtp-host
            - name: SMTP_NAME
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: smtp-username
            - name: SMTP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: test-nextcloud
                  key: smtp-password
            - name: REDIS_HOST
              value: test-redis-master
            - name: REDIS_HOST_PORT
              value: "6379"
            - name: REDIS_HOST_PASSWORD
              value: willTHEfragmatismwane2towardsthe3quantumlogician.
            - name: PGSSLCERT
              value: /tmp/postgresql.crt
          resources:
            limits:
              cpu: "1"
              memory: 1G
            requests:
              cpu: 100m
              memory: 50M
          volumeMounts:
            - name: nextcloud-main
              mountPath: /var/www/
              subPath: root
            - name: nextcloud-main
              mountPath: /var/www/html
              subPath: html
            - name: nextcloud-data
              mountPath: /nextcloud_data
              subPath: data
            - name: nextcloud-main
              mountPath: /var/www/html/config
              subPath: config
            - name: nextcloud-main
              mountPath: /var/www/html/custom_apps
              subPath: custom_apps
            - name: nextcloud-main
              mountPath: /var/www/tmp
              subPath: tmp
            - name: nextcloud-main
              mountPath: /var/www/html/themes
              subPath: themes
            - name: nextcloud-config
              mountPath: /var/www/html/config/cron.config.php
              subPath: cron.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/misc.config.php
              subPath: misc.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/.htaccess
              subPath: .htaccess
            - name: nextcloud-config
              mountPath: /var/www/html/config/apache-pretty-urls.config.php
              subPath: apache-pretty-urls.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/apcu.config.php
              subPath: apcu.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/apps.config.php
              subPath: apps.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/autoconfig.php
              subPath: autoconfig.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/redis.config.php
              subPath: redis.config.php
            - name: nextcloud-config
              mountPath: /var/www/html/config/smtp.config.php
              subPath: smtp.config.php
            - mountPath: /docker-entrypoint-hooks.d/post-installation/post-installation.sh
              name: installation-scripts
              readOnly: true
              subPath: post-installation.sh
            - mountPath: /docker-entrypoint-hooks.d/pre-installation/wait-for-postgresql.sh
              name: installation-scripts
              readOnly: true
              subPath: wait-for-postgresql.sh
            - mountPath: /var/www/html/config/proxy.config.php
              name: additional-config
              subPath: proxy.config.php
            - mountPath: /usr/local/etc/php/conf.d/redis-session.ini
              name: additional-config
              subPath: redis-session.ini
            - mountPath: /usr/local/etc/php-fpm.d/www.conf
              name: additional-config
              subPath: php-fpm-www.conf
      volumes:
        - name: nextcloud-main
          persistentVolumeClaim:
            claimName: test-nextcloud-nextcloud
        - name: nextcloud-data
          persistentVolumeClaim:
            claimName: test-nextcloud-nextcloud-data
        - name: nextcloud-config
          configMap:
            name: test-nextcloud-config
        - name: nextcloud-nginx-config
          configMap:
            name: test-nextcloud-nginxconfig
        - configMap:
            defaultMode: 488
            name: nextcloud-installation-scripts
          name: installation-scripts
        - configMap:
            name: nextcloud-additional-config
          name: additional-config
      securityContext:
        fsGroup: 82
        fsGroupChangePolicy: OnRootMismatch
---
# Source: zalf-nextcloud/charts/nextcloud/charts/redis/templates/master/application.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: test-redis-master
  namespace: "fairagro-keycloak"
  labels:
    app.kubernetes.io/name: redis
    helm.sh/chart: redis-17.13.2
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: master
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: redis
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: master
  serviceName: test-redis-headless
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: redis
        helm.sh/chart: redis-17.13.2
        app.kubernetes.io/instance: test
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: master
      annotations:
        checksum/configmap: c9fa90cfaa75640bac8e2f0f54039da1f1e400da0ac667676bc5f94339183c75
        checksum/health: fa662376a83ce7ec4d423f273956583f70e12c7c35acdcf9e16846b05724620c
        checksum/scripts: 2aac2f97c06a0111c214a61148978d6ef9057ea2f344674b276cfc096bc309fa
        checksum/secret: e4da88e225c2a6d49b6740f9188c3d643e271a55beb5cf529dc55a431368b094
    spec:
      
      securityContext:
        fsGroup: 1001
      serviceAccountName: test-redis
      automountServiceAccountToken: true
      affinity:
        podAffinity:
          
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: redis
                    app.kubernetes.io/instance: test
                    app.kubernetes.io/component: master
                topologyKey: kubernetes.io/hostname
              weight: 1
        nodeAffinity:
          
      terminationGracePeriodSeconds: 30
      containers:
        - name: redis
          image: docker.io/bitnami/redis@sha256:413ba6ab7104ced40c1047451680f0679b235684a14a7db4a05a5990ff4e1e67
          imagePullPolicy: "IfNotPresent"
          securityContext:
            runAsUser: 1001
          command:
            - /bin/bash
          args:
            - -c
            - /opt/bitnami/scripts/start-scripts/start-master.sh
          env:
            - name: BITNAMI_DEBUG
              value: "false"
            - name: REDIS_REPLICATION_MODE
              value: master
            - name: ALLOW_EMPTY_PASSWORD
              value: "no"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: test-redis
                  key: redis-password
            - name: REDIS_TLS_ENABLED
              value: "no"
            - name: REDIS_PORT
              value: "6379"
          ports:
            - name: redis
              containerPort: 6379
          livenessProbe:
            initialDelaySeconds: 20
            periodSeconds: 5
            # One second longer than command timeout should prevent generation of zombie processes.
            timeoutSeconds: 6
            successThreshold: 1
            failureThreshold: 5
            exec:
              command:
                - sh
                - -c
                - /health/ping_liveness_local.sh 5
          readinessProbe:
            initialDelaySeconds: 20
            periodSeconds: 5
            timeoutSeconds: 2
            successThreshold: 1
            failureThreshold: 5
            exec:
              command:
                - sh
                - -c
                - /health/ping_readiness_local.sh 1
          resources:
            limits:
              cpu: "1"
              memory: 1G
            requests:
              cpu: "1"
              memory: 1G
          volumeMounts:
            - name: start-scripts
              mountPath: /opt/bitnami/scripts/start-scripts
            - name: health
              mountPath: /health
            - name: redis-data
              mountPath: /data
            - name: config
              mountPath: /opt/bitnami/redis/mounted-etc
            - name: redis-tmp-conf
              mountPath: /opt/bitnami/redis/etc/
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: start-scripts
          configMap:
            name: test-redis-scripts
            defaultMode: 0755
        - name: health
          configMap:
            name: test-redis-health
            defaultMode: 0755
        - name: config
          configMap:
            name: test-redis-configuration
        - name: redis-tmp-conf
          emptyDir: {}
        - name: tmp
          emptyDir: {}
        - name: redis-data
          emptyDir: {}
---
# Source: zalf-nextcloud/charts/collabora-online/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: test-collabora-online
  labels:
    helm.sh/chart: collabora-online-1.1.11
    app.kubernetes.io/name: collabora-online
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "23.05.8.4.1"
    app.kubernetes.io/managed-by: Helm
  annotations:
    cert-manager.io/issuer: geant
    cert-manager.io/private-key-rotation-policy: Always
    cert-manager.io/private-key-size: "4096"
    cert-manager.io/subject-countries: DE
    cert-manager.io/subject-organizationalunits: Measure 4.1
    cert-manager.io/subject-organizations: NFDI FAIRagro
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/server-snippet: |
      location /cool/getMetrics { deny all; return 403; }
      location /cool/adminws/ { deny all; return 403; }
      location /browser/dist/admin/admin.html { deny all; return 403; }
    nginx.ingress.kubernetes.io/upstream-hash-by: $arg_WOPISrc
spec:
  ingressClassName: nginx-external
  tls:
    - hosts:
        - "collabora.fairagro.net"
      secretName: collabora-tls-secret
  rules:
    - host: "collabora.fairagro.net"
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: test-collabora-online
                port:
                  number: 9980
---
# Source: zalf-nextcloud/charts/fairagro-onlyoffice/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: test-fairagro-onlyoffice
  labels:
    helm.sh/chart: fairagro-onlyoffice-0.1.0
    app.kubernetes.io/name: fairagro-onlyoffice
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "8.0.1"
    app.kubernetes.io/managed-by: Helm
  annotations:
    cert-manager.io/issuer: geant
    cert-manager.io/private-key-rotation-policy: Always
    cert-manager.io/private-key-size: "4096"
    cert-manager.io/subject-countries: DE
    cert-manager.io/subject-organizationalunits: Measure 4.1
    cert-manager.io/subject-organizations: NFDI FAIRagro
spec:
  ingressClassName: nginx-external
  tls:
    - hosts:
        - "onlyoffice.fairagro.net"
      secretName: onlyoffice-tls-secret
  rules:
    - host: "onlyoffice.fairagro.net"
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: test-fairagro-onlyoffice
                port:
                  number: 80
---
# Source: zalf-nextcloud/charts/nextcloud/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: test-nextcloud
  labels:
    app.kubernetes.io/name: nextcloud
    helm.sh/chart: nextcloud-4.6.4
    app.kubernetes.io/instance: test
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: app
    app: nextcloud
  annotations:
    cert-manager.io/issuer: geant
    cert-manager.io/private-key-rotation-policy: Always
    cert-manager.io/private-key-size: "4096"
    cert-manager.io/subject-countries: DE
    cert-manager.io/subject-organizationalunits: Measure 4.1
    cert-manager.io/subject-organizations: NFDI FAIRagro
    nginx.ingress.kubernetes.io/cors-allow-headers: X-Forwarded-For
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: 128m
    nginx.ingress.kubernetes.io/server-snippet: |-
      server_tokens off;
      proxy_hide_header X-Powered-By;
      rewrite ^/.well-known/webfinger /index.php/.well-known/webfinger last;
      rewrite ^/.well-known/nodeinfo /index.php/.well-known/nodeinfo last;
      rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
      rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json;
      location = /.well-known/carddav {
        return 301 $scheme://$host/remote.php/dav;
      }
      location = /.well-known/caldav {
        return 301 $scheme://$host/remote.php/dav;
      }
      location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
      }
      location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ {
        deny all;
      }
      location ~ ^/(?:autotest|occ|issue|indie|db_|console) {
        deny all;
      }
spec:
  ingressClassName: nginx-external
  rules:
    - host: nextcloud.fairagro.net
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: test-nextcloud
                port:
                  number: 8080
  tls:
    - hosts:
      - nextcloud.fairagro.net
      secretName: nextcloud-tls-secret
---
# Source: zalf-nextcloud/templates/issuers.yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: letsencrypt
spec:
  acme:
    # The ACME server URL
    #server: https://acme-staging-v02.api.letsencrypt.org/directory # staging
    server: https://acme-v02.api.letsencrypt.org/directory # production
    # Email address used for ACME registration
    email: "carsten.scharfenberg@zalf.de"
    # Name of a secret used to store the ACME account private key
    privateKeySecretRef:
      name: cert-issuer-letsencrypt
    # Enable the DNS-01 challenge provider
    solvers:
      - dns01:
          cloudflare:
            apiTokenSecretRef:
              name: cloudflare-api-token-secret
              key: api-token
---
# Source: zalf-nextcloud/templates/issuers.yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: geant
spec:
  acme:
    # The ACME server URL
    server: https://acme.sectigo.com/v2/OV
    # Email address used for ACME registration
    email: "carsten.scharfenberg@zalf.de"
    externalAccountBinding:
      keyID: "OqJJqONZBNIdYFekHDIDRQ"
      keySecretRef:
        name: geant-acme-account-secret
        key: secret
      keyAlgorithm: HS256
    # Name of a secret used to store the ACME account private key
    privateKeySecretRef:
      name: cert-issuer-geant
    # Enable the DNS-01 challenge provider
    solvers:
      - dns01:
          cloudflare:
            apiTokenSecretRef:
              name: cloudflare-api-token-secret
              key: api-token
---
# Source: zalf-nextcloud/charts/fairagro-onlyoffice/templates/postgres-db.yaml
# kubernetes endpoint and type of object definition
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  # name of the postgres cluster / this could be build from input from the intranet website
  name: 'test-fairagro-onlyoffice'
spec:
  # teamIds can be defined for the hole cluster and are there to group cluster e.g. by working group
  # must be configured in the postgres-operator yaml before using them here.
  teamId: "fairagro"
  # we only want to access postgres internally from within the cluster. So deactivate all loadbalancers.
  enableMasterLoadBalancer: false
  enableMasterPoolerLoadBalancer: false
  enableReplicaLoadBalancer: false
  enableReplicaPoolerLoadBalancer: false
  # size of the database in GByte
  volume:
    size: "1Gi"
    storageClass: "nfs-csi-delete"
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      memory: 2Gi
      cpu: "1"
  # number of replicas, this can improve performance and failsafe
  numberOfInstances: 2
  # list of users and there rights
  users:
    # database owner
    "onlyoffice":
      - superuser
      - createdb

  # database and owner definition
  # databases: name->owner
  databases:
    "onlyoffice": "onlyoffice"
  "onlyoffice":
    onlyoffice:
      schemas:
        public: {}

  # postgresql database version
  postgresql:
    version: "15"
    parameters:
      password_encryption: scram-sha-256
---
# Source: zalf-nextcloud/templates/postgres-db.yaml
# kubernetes endpoint and type of object definition
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  # name of the postgres cluster / this could be build from input from the intranet website
  name: fairagro-postgresql-nextcloud
spec:
  # teamIds can be defined for the hole cluster and are there to group cluster e.g. by working group
  # must be configured in the postgres-operator yaml before using them here.
  teamId: "fairagro"
  # we only want to access postgres internally from within the cluster. So deactivate all loadbalancers.
  enableMasterLoadBalancer: false
  enableMasterPoolerLoadBalancer: false
  enableReplicaLoadBalancer: false
  enableReplicaPoolerLoadBalancer: false
  # size of the database in GByte
  volume:
    size: "4Gi"
    storageClass: "nfs-csi-delete"
  # The database is burstable
  resources:
    requests:
      cpu: '2'
      memory: 2G
    limits:
      cpu: '4'
      memory: 8G
  # number of replicas, this can improve performance and failsafe
  numberOfInstances: 2
  # list of users and there rights
  users:
    # database owner
    nextcloud:
      - superuser
      - createdb

  # database and owner definition
  # databases: name->owner
  databases:
    nextcloud: nextcloud
  preparedDatabases:
    nextcloud:
      schemas:
        public: {}

  # postgresql database version
  postgresql:
    version: "15"
    parameters:
      password_encryption: scram-sha-256
---
# Source: zalf-nextcloud/charts/fairagro-onlyoffice/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "test-fairagro-onlyoffice-test-connection"
  labels:
    helm.sh/chart: fairagro-onlyoffice-0.1.0
    app.kubernetes.io/name: fairagro-onlyoffice
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "8.0.1"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['test-fairagro-onlyoffice:80']
  restartPolicy: Never
